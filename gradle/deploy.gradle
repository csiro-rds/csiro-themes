/*
 * Scripts for deploying CSIRO Providence themes.
 *
 * NB: This script is conditionally applied. Any new tasks will need to be included in the conditions in build.gradle.
 *
 * Usage: gradle deployToServer
 */

// Make sure the required params are supplied. This is generally done by the CI job's
// "Properties Content" field with a prefix of ORG_GRADLE_PROJECT_
// e.g.  ORG_GRADLE_PROJECT_deployuser=auser
// or they can be added locally to your gradle.properties
assert project.hasProperty('deployuser'), 'Properties for deployment must be provided'
assert project.hasProperty('deploypassword'), 'Properties for deployment must be provided'
assert System.env.BUILD_NUMBER, 'Deploying must be done by the appropriate Jenkins job'
assert project.hasProperty('remoteHost'), 'The remote host for the deployment must be specified'
assert project.hasProperty('appUser'), 'The application user name must be specified'
assert project.hasProperty('targetEnv'), 'The name of the target environment must be specified'

// Ssh settings
ssh {
  knownHosts = allowAnyHosts    // Disable host key verification
}

// Define the remote server we are interacting with.
remotes {
    targetServer {
        host = remoteHost
        user = deployuser
        password = deploypassword
    }
}

def themesRemoteBaseDir = '/srv/cms/deployment/csiro-themes'
def applicationRemoteBaseDir = '/srv/www'
def applicationRemoteThemesDir = "${applicationRemoteBaseDir}/providence/themes"
def downloadFolder = "${buildDir}/download"
def downloadedArtifact = file("${downloadFolder}/csiro-themes-${project.version}.zip")
def repoUrl = 'http://jenkins-apps.it.csiro.au:8081/nexus/service/local/artifact/maven/redirect?r=cd'

task makeDownloadFolder() {
    mkdir file(downloadFolder)
}

task downloadBinaryArchive(dependsOn: makeDownloadFolder) {
    description 'Download our target zip file from the nexus repository'
    group 'Continuous Delivery'

    doLast {
        ext {
            binaryUrl = "${repoUrl}&g=${project.group}&a=${distributions.main.baseName}&e=zip&v=${project.version}"
            println binaryUrl
        }

        ant.get(src: binaryUrl, dest: downloadedArtifact)
    }
}

task deployToServer(type: SshTask, dependsOn: downloadBinaryArchive) {
    description 'Deploy CMS themes to the required server. Intended for use by the Jenkins deploy jobs only.'
    group 'Continuous Delivery'

    doFirst {
        println "Deploying CMS themes build ${project.version} to server ${remotes.targetServer.host}"
    }

    // Note: Each sudo command here must be specifically allowed in the remote host sudoers config.
    session(remotes.targetServer) {
        def asUser = "sudo -u ${appUser}"
        def remoteProjectRootDir = "${themesRemoteBaseDir}"
        def remoteProjectDistDir = "/tmp"
        def remoteProjectDist = "${remoteProjectDistDir}/csiro-themes-${project.version}.zip"
        def remoteProjectNrcaThemeDir = "${remoteProjectRootDir}/csiro-nrca"

        println "Uploading ${downloadedArtifact} to ${remoteProjectDist}"
        put downloadedArtifact, "${remoteProjectDist}"

        println "Extracting ${remoteProjectDist} to ${remoteProjectDistDir} (overwriting existing if it exists)"
        println("${asUser} unzip -o \"${remoteProjectDist}\" -d \"${remoteProjectDistDir}\"")
        execute("${asUser} unzip -o \"${remoteProjectDist}\" -d \"${remoteProjectDistDir}\"")

        println "Copying extracted files from ${remoteProjectDistDir}/${project.version} to ${remoteProjectRootDir}"
        println("${asUser} rsync -a --delete-after \"${remoteProjectDistDir}/csiro-themes-${project.version}/\" \"${remoteProjectRootDir}/\"")
        execute("${asUser} rsync -a --delete-after \"${remoteProjectDistDir}/csiro-themes-${project.version}/\" \"${remoteProjectRootDir}/\"")

        println "Creating symbolic link into Providence themes directory"
        println("${asUser} ln -fns \"${remoteProjectNrcaThemeDir}\" \"${applicationRemoteThemesDir}/\"")
        execute("${asUser} ln -fns \"${remoteProjectNrcaThemeDir}\" \"${applicationRemoteThemesDir}/\"")
    }
}
